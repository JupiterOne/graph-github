import { RelationshipClass, StepSpec } from '@jupiterone/integration-sdk-core';
import { IntegrationConfig } from '../../../../src/config';

export const vulnerabilityAlertSpec: StepSpec<IntegrationConfig>[] = [
  {
    id: 'fetch-github-vuln-alert',
    name: 'Fetch GitHub Vuln Alert',
    entities: [
      {
        resourceName: 'GitHub Vulnerability Alert',
        _type: 'github_finding',
        _class: 'Finding',
        schema: {
          properties: {
            id: { type: 'string' }, // 'alert.securityAdvisory.id=GSA_kwCzR0hTQS03NGZqLTJqMmgtYzQycc0hVA'
            name: { type: 'string' }, // 'alert.securityAdvisory.summary=Exposure of sensitive information in follow-redirects'
            displayName: { type: 'string' }, // 'alert.securityAdvisory.summary=Exposure of sensitive information in follow-redirects'
            summary: { type: 'string' }, // 'alert.securityAdvisory.description=follow-redirects is vulnerable to Exposure of Private Personal Information to an Unauthorized Actor'
            category: { type: 'string' }, // 'application',
            status: { type: 'string' }, // 'alert.state=OPEN',
            severity: { type: 'string' }, // 'alert.securityVulnerability.severity=HIGH',
            numericSeverity: { type: 'number' }, // 'alert.securityAdvisory.cvss.score=8.0',
            priority: { type: 'string' }, // 'alert.securityVulnerability.severity=HIGH',
            score: { type: 'number' }, // 'alert.securityAdvisory.cvss.score=8.0',
            impact: { type: 'string' }, // 'alert.securityAdvisory.summary=Exposure of sensitive information in follow-redirects',
            vector: { type: 'string' }, // 'alert.securityAdvisory.cvss.vectorString=CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:U/C:H/I:H/A:H',
            recommendation: { type: 'string' }, // 'Update NPM package "follow-redirects" to >= 1.14.8', // This string is built from alert.securityVulnerability
            targets: {
              // ['alert.repository.nameWithOwner=JupiterOne/graph-signal-sciences',],
              type: 'array',
              items: {
                type: 'string',
              },
            },
            open: { type: 'boolean' }, // 'alert.state===OPEN: true',
            references: { type: 'array', items: { type: 'string' } }, //'alert.securityAdvisory.references=[urls]',
            public: { type: 'string' }, // 'alert.securityAdvisory.identifiers.includes("type=cve"): true',
            weblink: { type: 'string' }, // construct URL: 'https://github.com/JupiterOne/graph-signal-sciences/security/dependabot/1',
            createdOn: { type: 'number' }, // alert.createdAt
            dismissedOn: { type: 'number' }, // alert.dismissedAt
            dismisserLogin: { type: 'string' }, // alert.dismisser.login
            dismissReason: { type: 'string' }, // alert.dismissedReason
            fixReason: { type: 'string' },
            number: { type: 'number' },
            databaseId: { type: 'number' },
            ghsaId: { type: 'string' },
            origin: { type: 'string' },
            publishedOn: { type: 'number' }, // alert.publishedAt
            updatedOn: { type: 'number' }, // alert.updatedAt
            withdrawnOn: { type: 'number' }, // alert.withdrawnAt
            packageName: { type: 'string' }, // alert.securityVulnerability.package.name
            packageEcosystem: { type: 'string' }, // alert.securityVulnerability.package.ecosystem
            vulnerableVersionRange: { type: 'string' },
            vulnerableManifestFilename: { type: 'string' },
            vulnerableManifestPath: { type: 'string' },
            vulnerableRequirements: { type: 'string' },
          },
        },
      },
      {
        resourceName: 'CVE',
        _type: 'cve',
        _class: 'Vulnerability',
        schema: {
          properties: {
            name: { type: 'string' },
            displayName: { type: 'string' },
            cvssScore: { type: 'string' },
            references: { type: 'array', items: { type: 'string' } },
            webLink: { type: 'string' },
          },
        },
      },
      {
        resourceName: 'CWE',
        _type: 'cwe',
        _class: 'Weakness',
        schema: {
          properties: {
            name: { type: 'string' },
            displayName: { type: 'string' },
            description: { type: 'string' },
            references: { type: 'array', items: { type: 'string' } },
            webLink: { type: 'string' },
          },
        },
      },
    ],
    relationships: [
      {
        _type: 'github_repo_has_vuln_alert',
        sourceType: 'github_repo',
        _class: RelationshipClass.HAS,
        targetType: 'github_finding',
      },
      {
        _type: 'github_finding_is_cve',
        sourceType: 'github_finding',
        _class: RelationshipClass.IS,
        targetType: 'cve',
      },
      {
        _type: 'github_finding_exploits_cwe',
        sourceType: 'github_finding',
        _class: RelationshipClass.EXPLOITS,
        targetType: 'cwe',
      },
    ],
    dependsOn: ['fetch-repos'],
    implemented: false,
  },
];
