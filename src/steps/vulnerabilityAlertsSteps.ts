import {
  createDirectRelationship,
  Entity,
  IntegrationStep,
  IntegrationStepExecutionContext,
  RelationshipClass,
} from '@jupiterone/integration-sdk-core';
import { IntegrationConfig } from '../config';
import { getOrCreateApiClient } from '../client';
import { RepoEntity, VulnerabilityAlertEntity } from '../types';
import {
  GITHUB_FINDING_CVE_RELATIONSHIP_TYPE,
  GITHUB_FINDING_CWE_RELATIONSHIP_TYPE,
  GITHUB_REPO_FINDING_RELATIONSHIP_TYPE,
  GithubEntities,
} from '../constants';
import {
  toCveEntity,
  toCweEntity,
  toVulnerabilityAlertEntity,
} from '../sync/converters';

export async function fetchVulnAlerts({
  instance,
  logger,
  jobState,
}: IntegrationStepExecutionContext<IntegrationConfig>) {
  const { config } = instance;
  const apiClient = getOrCreateApiClient(config, logger);

  await jobState.iterateEntities<RepoEntity>(
    { _type: GithubEntities.GITHUB_REPO._type },
    async (repoEntity) => {
      await apiClient.iterateRepoVulnAlerts(repoEntity, async (vulnAlert) => {
        const vulnAlertEntity = (await jobState.addEntity(
          toVulnerabilityAlertEntity(vulnAlert, config.githubApiBaseUrl),
        )) as VulnerabilityAlertEntity;

        await jobState.addRelationship(
          createDirectRelationship({
            _class: RelationshipClass.HAS,
            from: repoEntity,
            to: vulnAlertEntity,
          }),
        );

        let cveEntity = toCveEntity(vulnAlert) as Entity;
        if (cveEntity) {
          if (!(await jobState.hasKey(cveEntity._key))) {
            cveEntity = (await jobState.addEntity(cveEntity)) as Entity;
          }

          await jobState.addRelationship(
            createDirectRelationship({
              _class: RelationshipClass.IS,
              from: vulnAlertEntity,
              to: cveEntity,
            }),
          );
        }

        const cwes = vulnAlert.securityAdvisory?.cwes ?? [];
        await Promise.all(
          cwes.map(async (cwe) => {
            const cweKey = cwe.cweId.toLowerCase();

            let cweEntity = await jobState.findEntity(cweKey);
            if (!cweEntity) {
              cweEntity = await jobState.addEntity(toCweEntity(cwe));
            }

            await jobState.addRelationship(
              createDirectRelationship({
                _class: RelationshipClass.EXPLOITS,
                from: vulnAlertEntity,
                to: cweEntity,
              }),
            );
          }),
        );
      });
    },
  );
}

export const vulnerabilityAlertsSteps: IntegrationStep<IntegrationConfig>[] = [
  {
    id: 'fetch-vulnerability-alerts',
    name: 'Fetch Vulnerability Alerts',
    entities: [
      {
        resourceName: 'GitHub Vulnerability Alerts',
        _type: GithubEntities.GITHUB_VULNERABILITY_ALERT._type,
        _class: GithubEntities.GITHUB_VULNERABILITY_ALERT._class,
      },
      {
        resourceName: 'CVE',
        _type: GithubEntities.CVE._type,
        _class: GithubEntities.CVE._class,
      },
      {
        resourceName: 'CWE',
        _type: GithubEntities.CWE._type,
        _class: GithubEntities.CWE._class,
      },
    ],
    relationships: [
      {
        _type: GITHUB_REPO_FINDING_RELATIONSHIP_TYPE,
        sourceType: GithubEntities.GITHUB_REPO._type,
        _class: RelationshipClass.HAS,
        targetType: GithubEntities.GITHUB_VULNERABILITY_ALERT._type,
      },
      {
        _type: GITHUB_FINDING_CVE_RELATIONSHIP_TYPE,
        sourceType: GithubEntities.GITHUB_VULNERABILITY_ALERT._type,
        _class: RelationshipClass.IS,
        targetType: GithubEntities.CVE._type,
      },
      {
        _type: GITHUB_FINDING_CWE_RELATIONSHIP_TYPE,
        sourceType: GithubEntities.GITHUB_VULNERABILITY_ALERT._type,
        _class: RelationshipClass.EXPLOITS,
        targetType: GithubEntities.CWE._type,
      },
    ],
    dependsOn: ['fetch-repos'],
    executionHandler: fetchVulnAlerts,
  },
];
