jest.setTimeout(100000);

import {
  Recording,
  executeStepWithDependencies,
} from '@jupiterone/integration-sdk-testing';
import {
  buildStepTestConfig,
  filterDirectRelationships,
} from '../../test/config';
import { setupGithubRecording } from '../../test/recording';
import { Steps } from '../constants';

let recording: Recording;
afterEach(async () => {
  await recording.stop();
});

describe('vulnerabilityAlertsStep', () => {
  test('fetchVulnerabilityAlerts exec handler', async () => {
    recording = setupGithubRecording({
      directory: __dirname,
      name: 'vulnAlerts',
    });

    const stepConfig = buildStepTestConfig(Steps.FETCH_VULNERABILITY_ALERTS);
    const stepResults = await executeStepWithDependencies(stepConfig);

    expect({
      ...stepResults,
      // HACK: `@jupiterone/integration-sdk-testing`
      // does not currently support `toMatchStepMetadata` with mapped
      // relationships, which is causing tests to fail. We will add
      // support soon and remove this hack.
      collectedRelationships: filterDirectRelationships(
        stepResults.collectedRelationships,
      ),
    }).toMatchStepMetadata({
      ...stepConfig,
      invocationConfig: {
        ...stepConfig.invocationConfig,
        integrationSteps: stepConfig.invocationConfig.integrationSteps.map(
          (s) => {
            return {
              ...s,
              mappedRelationships: [],
            };
          },
        ),
      },
    });
  });
});
